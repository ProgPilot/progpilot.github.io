

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
    <link rel="shortcut icon" href="/favicon.ico">

    <style>

        @import url("https://fonts.googleapis.com/css?family=Lato:400,400italic,700,700italic");

        .leftpad {
            padding-left: 5px;
        }

        .image-background {
            background-image: url("https://www.progpilot.com/writeups/resources/banner.jpg");
            background-size: cover;
        }

        .header {
            font-family: 'Roboto Mono', monospace;
            color: white;
        }

        .white {
            color: white;
        }

        .whitelink, .whitelink:hover, .whitelink:active, .whitelink:visited {
            color: white;
        }

        .breadcrumb {
            margin-bottom: unset;
            background-color: unset;
            border-radius: unset;
        }

        .breadcrumb-item + .breadcrumb-item::before {
            display: inline-block;
            padding-right: 0.5rem;
            color: white;
            content: ">";
        }

        body {
            font-family: "Lato", sans-serif;
        }

        .navbar a:hover {
            text-decoration: none;
        }

        .p-3 {
            padding: $spacer !important;
        }

    </style>

    
        
    

    <title>Moar Horse 4 | ProgPilot writeups</title>

    <meta name="description" content="Writeup by the CTF team ProgPilot for Moar Horse 4 (TJCTF 2020)">

    <meta property="og:title" content="Moar Horse 4">

<meta property="og:site_name" content="progpilot.com">
<meta property="og:description" content="Writeup by the CTF team ProgPilot for Moar Horse 4 (TJCTF 2020)">
<meta property="og:url" content="https://www.progpilot.com/writeups/tj2020/moarhorse">
<meta property="og:image" content="https://www.progpilot.com/writeups/resources/progpilot.jpg">
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-166229733-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-166229733-1');
</script>

    

    <style>
    .videoWrapper {
    	position: relative;
    	padding-bottom: 56.25%; /* 16:9 */
    	padding-top: 25px;
    	height: 0;
    }
    .videoWrapper iframe {
    	position: absolute;
    	top: 0;
    	left: 0;
    	width: 100%;
    	height: 100%;
    }

	img {
		max-width: 100%;
		height: auto;
		display: block;
		margin-left: auto;
		margin-right: auto;
		border-style: solid;
		border-width: 1px;
	}
    </style>


</head>
<body>

    <nav class="navbar navbar-expand-lg image-background white">
    <div class="navbar-brand">
        <a class="header whitelink" href="https://www.progpilot.com/writeups/">ProgPilot writeups</a>
    </div>

    <div class="collapse navbar-collapse">
        <div class="navbar-nav mr-auto">
            <ol class="breadcrumb">
                
                
                <li class="breadcrumb-item"><a class="whitelink" href="https://www.progpilot.com/writeups/">Home</a></li>
                
                
                
                <li class="breadcrumb-item"><a class="whitelink" href="../">TJCTF 2020</a></li>
                
                
                
                <li class="breadcrumb-item" aria-current="page">Moar Horse 4</li>
                
                
            </ol>
        </div>

        
    </div>

</nav>

    <div class="container">

        <div class="p-3"></div>

        

    <h4>Writeup for <b>Moar Horse 4</b></h4>
    <p>Category: Web<br>Author: Tom<br>

          

            Tags:

            

                <span class="badge badge-secondary">jwt token</span>

            
        

    </p>

    <p>Moar Horse 4 was a challenge that formed part of the 2020 TJCTF, and I think my favourite challenge in the entire competition.</p>
<p>We're given a link to the a website, some server source code, an RSA public key and some other unrelated files like templates and images.</p>
<p>The website appears to be related to virtual horse racing. We have to accept some terms and conditions before entering the app. Pressing the button to accept these stores a <a href="https://en.wikipedia.org/wiki/JSON_Web_Token" target="_blank" rel="noopener">JWT token</a> in our cookies under the name <code>token</code>.</p>
<p>Further looking around the website, we can see we have $100 in money, a store and an option to race our horses. If we go to the store, we can buy a horse for $100 and race it in the race tab. Our money value and the names of any horses we buy are stored in the JWT token.</p>
<p><img src="https://cdn.tdpain.net/ctf-writeups/tj2020/moarhorse/store.png" alt="store"></p>
<p>When we race, we select our horse and race against the reigning champion. We lose :( We always lose. There's no way we can beat the champion, right?</p>
<p><img src="https://cdn.tdpain.net/ctf-writeups/tj2020/moarhorse/failedrace.png" alt="this horse sucks"></p>
<p>If we take a look at the source code provided with the challenge, we first see the two functions that handle JWT token generation and verification.</p>
<pre><code class="language-python">def validate_token(token):
    try:
        data = jwt.decode(token, PUBLIC_KEY)
        return all(attr in data for attr in [&quot;user&quot;,&quot;is_omkar&quot;,&quot;money&quot;,&quot;horses&quot;]), data
    except:
        return False, None

def generate_token(data):
    token = jwt.encode(data, PRIVATE_KEY, &quot;RS256&quot;)
    return token
</code></pre>
<p>Tokens are generated using the RS256 algorithm, meaning that the RSA algorithm is used for token signing. The token can only be signed using the private key.</p>
<p>Further into the source code, we see the race logic.</p>
<pre><code class="language-python">boss_speed = int(hashlib.md5((&quot;Horse_&quot; + BOSS_HORSE).encode()).hexdigest(), 16)
your_speed = int(hashlib.md5((&quot;Horse_&quot; + race_horse).encode()).hexdigest(), 16)
if your_speed &gt; boss_speed:
    return render_template(&quot;race_results.html&quot;, money=data[&quot;money&quot;], victory=True, flag=flag)
</code></pre>
<p>It takes the name of each horse competing, adds <code>Horse_</code> to the beginning, hashes it using MD5 and compares the numeric values of each hash. If our horse has the higher hash value, we win.</p>
<p>The name of the champion horse is <code>MechaOmkar-YG6BPRJM</code>, so its hash value is <code>340282329007027273925800828829408515216</code>. The best way to find a value that's bigger than this is using a wordlist (I used the bog standard rockyou.txt) and a simple script, a little bit of which you can see below. The full script is <a href="https://github.com/codemicro/ctf-writeups/blob/master/tj2020/moarhorse/hashfinder.py" target="_blank" rel="noopener">here</a>.</p>
<pre><code class="language-python">print(&quot;Running&quot;)
for word in wordlist:
    if int(hashlib.md5((prefix + word).encode()).hexdigest(), 16) &gt; boss_speed:
        print(prefix, &quot;'&quot; + word + &quot;'&quot;)
print(&quot;Done&quot;)
</code></pre>
<p>Any horse names that match the condition are printed out to the terminal. The script takes a couple of minutes to run, but we get the name <code>panchito00</code> printed out.</p>
<p><img src="https://cdn.tdpain.net/ctf-writeups/tj2020/moarhorse/hashinput.png" alt="hash magic"></p>
<p>But how are we meant to set this as our horse's name?</p>
<p>I'm glad you asked.</p>
<hr>
<p>Did you notice that in the JWT validation and generation code, the RS256 algorithm is only specified during generation and not on validation? This presents a security vulnerability. <a href="https://pyjwt.readthedocs.io/en/latest/api.html?highlight=decode#jwt.decode" target="_blank" rel="noopener">The JWT library documentation even recommends that you specify the algorithm.</a></p>
<p>Since we have the public key, we can sign a JWT token with the public key using a symmetric algorithm like HS256 which will be validated and trusted by the web app.</p>
<p>A technique for doing this is documented <a href="https://www.nccgroup.com/uk/about-us/newsroom-and-events/blogs/2019/january/jwt-attack-walk-through/" target="_blank" rel="noopener">here</a>. It involves turning the public key into hex values turning it into a HMAC signature and tacking it onto our modified token with our modified horse name in it.</p>
<p><img src="https://cdn.tdpain.net/ctf-writeups/tj2020/moarhorse/jwtgen.png" alt="making our new token"></p>
<p>The original token looked like this</p>
<p><img src="https://cdn.tdpain.net/ctf-writeups/tj2020/moarhorse/stockjwt.png" alt="stock token"></p>
<p>Our modified token looked like this (at this point it wasn't signed using the public key).</p>
<p><img src="https://cdn.tdpain.net/ctf-writeups/tj2020/moarhorse/partjwt.png" alt="evil jwt muahahaha"></p>
<p>Replacing our new token with the old one in the <code>token</code> cookie gave our horse the name <code>panchito00</code>, which we could race and use to get the flag!</p>
<p><img src="https://cdn.tdpain.net/ctf-writeups/tj2020/moarhorse/flag.png" alt="flag"></p>
<p>The provided source code and hash finder script can be found <a href="https://github.com/codemicro/ctf-writeups/blob/master/tj2020/moarhorse/" target="_blank" rel="noopener">here</a>.</p>
<p><img src="https://cdn.tdpain.net/ctf-writeups/tj2020/moarhorse/chall.png" alt="chall"></p>




        <div class="p-3"></div>

        <footer style="font-size: 0.8em;">
    Site last updated on Mon, 13 July @ 10:40AM<br>
    Content copyright &copy; <script>document.write(new Date().getFullYear())</script> ProgPilot
</footer>
<br>

    </div>
</body>
</html>